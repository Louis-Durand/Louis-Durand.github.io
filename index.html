<!DOCTYPE html>
<html>
  <head>
    <style>
      .highlight {
        fill: orange;
      }
    </style>
    <script src="https://d3js.org/d3.v4.min.js"></script>
  </head>
  <body>
    <svg width="9000" height="700"></svg>
    <script>
      var svg = d3.select("svg"),
        margin = 200,
        width = svg.attr("width") - margin,
        height = svg.attr("height") - margin;

      svg
        .append("text")
        .attr("transform", "translate(100,0)")
        .attr("x", 50)
        .attr("y", 100)
        .attr("font-size", "24px")
        .text("Gold Stock Price");

      var x = d3.scaleBand().range([0, width]).padding(0.4),
        y = d3.scaleLinear().range([height, 0]);

      var g = svg
        .append("g")
        .attr("transform", "translate(" + 100 + "," + 100 + ")");

      d3.csv("src/dates.csv", function (error, data_dates) {
        if (error) {
          throw error;
        }
        d3.csv("src/data.csv", function (error, data) {
          if (error) {
            throw error;
          }
          data.forEach(function (d) {
            //          d.date = +d.date.split(" - ")[0];
          });

          x.domain(
            data.map(function (d) {
              return d.date;
            })
          );
          y.domain([
            0,
            1900 // Why does the max not get set
            //          d3.max(data, function (d) {
            //            return d.price;
            //          })
          ]);

          g.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x))
            .selectAll("text")
            .style("text-anchor", "end")
            .attr("transform", "rotate(-90)")
            .attr("y", -4.5)
            .attr("x", -10)
            .attr("stroke", "black");

          g.append("g")
            .call(
              d3
                .axisLeft(y)
                .tickFormat(function (d) {
                  return "$" + d;
                })
                .ticks(15)
            )
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", "-5.1em")
            .attr("text-anchor", "end")
            .attr("stroke", "black")
            .text("Stock Price");

          g.selectAll(".bar")
            .data(data)
            .enter()
            .append("rect")
            .attr("class", "bar")
            .attr("fill", function (d) {
              if (
                d.date === "1971-11-01" ||
                d.date === "1971-12-01" ||
                d.date === "1973-03-01" ||
                d.date === "1974-12-01" ||
                d.date === "1975-02-01" ||
                d.date === "1976-06-01" ||
                d.date === "1979-11-01" ||
                d.date === "1982-03-01" ||
                d.date === "1987-01-01" ||
                d.date === "1987-10-01" ||
                d.date === "1990-08-01" ||
                d.date === "1991-08-01" ||
                d.date === "1997-08-01" ||
                d.date === "1999-01-01" ||
                d.date === "1999-09-01" ||
                d.date === "2001-09-01" ||
                d.date === "2001-10-01" ||
                d.date === "2002-10-01" ||
                d.date === "2003-03-01" ||
                d.date === "2003-05-01" ||
                d.date === "2004-11-01" ||
                d.date === "2006-01-01" ||
                d.date === "2007-12-01" ||
                d.date === "2008-11-01" ||
                d.date === "2010-02-01" ||
                d.date === "2010-01-01" ||
                d.date === "2010-08-01" ||
                d.date === "2011-08-01" ||
                d.date === "2011-09-01" ||
                d.date === "2012-09-01"
              ) {
                return "red";
              }
              return "blue";
            })

            .on("mouseover", onMouseOver) //Add listener for the mouseover event
            .on("mouseout", onMouseOut) //Add listener for the mouseout event
            .attr("x", function (d) {
              return x(d.date);
            })
            .attr("y", function (d) {
              return y(d.price);
            })
            .attr("width", x.bandwidth())
            .transition()
            .ease(d3.easeLinear)
            .duration(200)
            .delay(function (d, i) {
              return i * 1;
            })
            .attr("height", function (d) {
              return height - y(d.price);
            });
        });
      });
      //mouseover event handler function
      function onMouseOver(d, i) {
        d3.select(this).attr("class", "highlight");
        d3.select(this)
          .transition() // adds animation
          .duration(200)
          .attr("width", x.bandwidth() + 5)
          .attr("y", function (d) {
            return y(d.price) - 10;
          })
          .attr("height", function (d) {
            return height - y(d.price) + 10;
          });

        g.append("text")
          .attr("class", "val")
          .attr("x", function () {
            return x(d.date);
          })
          .attr("y", function () {
            return y(d.price) - 25;
          })
          .text(function () {
            if (d.date === "1971-11-01") {
              return [
                "$" +
                  d.price +
                  " Suspension of dollar's convertibility into gold"
              ];
            }
            if (d.date === "1971-12-01") {
              return ["$" + d.price + " The Smithsonian Agreement"];
            }
            if (d.date === "1973-03-01") {
              return [
                "$" +
                  d.price +
                  " End of the Bretton Woods fixed exchange rate system"
              ];
            }
            if (d.date === "1974-12-01") {
              return [
                "$" +
                  d.price +
                  " Private ownership of gold of all forms legal in the US"
              ];
            }
            if (d.date === "1975-02-01") {
              return ["$" + d.price + " Gold futures trading begins in the US"];
            }
            if (d.date === "1976-06-01") {
              return ["$" + d.price + " IMF gold sales program"];
            }
            if (d.date === "1979-11-01") {
              return ["$" + d.price + " Iranian hostage crisis"];
            }
            if (d.date === "1982-03-01") {
              return [
                "$" +
                  d.price +
                  " US Gold Commission rejects return to gold standard"
              ];
            }
            if (d.date === "1987-01-01") {
              return ["$" + d.price + " Establishment of World Gold Council"];
            }
            if (d.date === "1987-10-01") {
              return ["$" + d.price + " Black Monday stock market crash"];
            }
            if (d.date === "1990-08-01") {
              return ["$" + d.price + " Gulf War"];
            }
            if (d.date === "1991-08-01") {
              return ["$" + d.price + " Dissolution of the USSR"];
            }
            if (d.date === "1997-08-01") {
              return [
                "$" +
                  d.price +
                  " Passage of Taxpayers Relief Act by US Congress"
              ];
            }
            if (d.date === "1999-01-01") {
              return ["$" + d.price + " The introduction of Euro"];
            }
            if (d.date === "1999-09-01") {
              return ["$" + d.price + " Central Bank Gold Agreements"];
            }
            if (d.date === "2001-09-01") {
              return ["$" + d.price + " September 11th Terrorist Attack"];
            }
            if (d.date === "2001-10-01") {
              return ["$" + d.price + " War in Afghanistan"];
            }
            if (d.date === "2002-10-01") {
              return [
                "$" + d.price + " Shanghai Gold Exchange begins operation"
              ];
            }
            if (d.date === "2003-03-01") {
              return ["$" + d.price + " Iraq War"];
            }
            if (d.date === "2003-05-01") {
              return ["$" + d.price + " US occupation of Iraq"];
            }
            if (d.date === "2004-11-01") {
              return ["$" + d.price + " Launch of SPDR Gold Trust ETF"];
            }
            if (d.date === "2006-01-01") {
              return ["$" + d.price + " Iran nuclear crisis"];
            }
            if (d.date === "2007-12-01") {
              return ["$" + d.price + " The Great Recession"];
            }
            if (d.date === "2008-11-01") {
              return ["$" + d.price + " QE1"];
            }
            if (d.date === "2010-02-01") {
              return ["$" + d.price + " IMF gold sales"];
            }
            if (d.date === "2010-01-01") {
              return [
                "$" + d.price + " Central banks become net purchasers of gold"
              ];
            }
            if (d.date === "2010-08-01") {
              return ["$" + d.price + " QE2"];
            }
            if (d.date === "2011-08-01") {
              return [
                "$" + d.price + " S&P's lowering of long-term US credit rating "
              ];
            }
            if (d.date === "2011-09-01") {
              return ["$" + d.price + " Operation Twist"];
            }
            if (d.date === "2012-09-01") {
              return ["$" + d.price + " QE3"];
            }
            return ["$" + d.price]; // Value of the text
          });
      }
      //mouseout event handler function
      function onMouseOut(d, i) {
        // use the text label class to remove label on mouseout
        d3.select(this).attr("class", "bar");
        d3.select(this)
          .transition() // adds animation
          .duration(400)
          .attr("width", x.bandwidth())
          .attr("y", function (d) {
            return y(d.price);
          })
          .attr("height", function (d) {
            return height - y(d.price);
          });

        d3.selectAll(".val").remove();
      }
    </script>
  </body>
</html>
